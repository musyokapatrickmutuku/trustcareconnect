# Prometheus alerting rules for TrustCareConnect
groups:
  - name: trustcareconnect.rules
    rules:
    
    # Service availability alerts
    - alert: ServiceDown
      expr: up == 0
      for: 2m
      labels:
        severity: critical
        service: '{{ $labels.job }}'
      annotations:
        summary: 'TrustCareConnect service {{ $labels.job }} is down'
        description: 'Service {{ $labels.job }} on instance {{ $labels.instance }} has been down for more than 2 minutes.'
        
    - alert: HighErrorRate
      expr: (rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])) > 0.1
      for: 5m
      labels:
        severity: warning
        service: '{{ $labels.job }}'
      annotations:
        summary: 'High error rate on {{ $labels.job }}'
        description: 'Error rate is {{ $value | humanizePercentage }} for service {{ $labels.job }} on {{ $labels.instance }}'
        
    # Response time alerts
    - alert: HighResponseTime
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
      for: 10m
      labels:
        severity: warning
        service: '{{ $labels.job }}'
      annotations:
        summary: 'High response time on {{ $labels.job }}'
        description: '95th percentile response time is {{ $value }}s for service {{ $labels.job }}'
        
    # AI Proxy specific alerts
    - alert: AIProxyDown
      expr: up{job="ai-proxy"} == 0
      for: 1m
      labels:
        severity: critical
        service: ai-proxy
      annotations:
        summary: 'AI Proxy service is down'
        description: 'The AI Proxy service is not responding. Patient queries will fail.'
        
    - alert: AIProxyHighLatency
      expr: histogram_quantile(0.95, rate(ai_proxy_request_duration_seconds_bucket[5m])) > 10
      for: 5m
      labels:
        severity: warning
        service: ai-proxy
      annotations:
        summary: 'AI Proxy high latency'
        description: 'AI Proxy 95th percentile response time is {{ $value }}s, which may impact user experience.'
        
    - alert: AIProxyAPIKeyError
      expr: increase(ai_proxy_api_key_errors_total[5m]) > 0
      for: 0m
      labels:
        severity: critical
        service: ai-proxy
      annotations:
        summary: 'AI Proxy API key errors detected'
        description: 'AI Proxy is experiencing API key authentication errors with external services.'
        
    # ICP Backend specific alerts
    - alert: ICPBackendDown
      expr: up{job="icp-backend"} == 0
      for: 2m
      labels:
        severity: critical
        service: icp-backend
      annotations:
        summary: 'ICP Backend canister is down'
        description: 'The Internet Computer backend canister is not responding.'
        
    - alert: ICPBackendMemoryHigh
      expr: icp_canister_memory_usage_bytes / icp_canister_memory_limit_bytes > 0.8
      for: 5m
      labels:
        severity: warning
        service: icp-backend
      annotations:
        summary: 'ICP Backend memory usage high'
        description: 'Backend canister memory usage is {{ $value | humanizePercentage }} of available memory.'
        
    - alert: ICPBackendCyclesLow
      expr: icp_canister_cycles_balance < 1000000000000  # Less than 1T cycles
      for: 5m
      labels:
        severity: warning
        service: icp-backend
      annotations:
        summary: 'ICP Backend cycles running low'
        description: 'Backend canister has {{ $value }} cycles remaining. Consider adding more cycles.'
        
    # Frontend specific alerts
    - alert: FrontendDown
      expr: up{job="frontend"} == 0
      for: 2m
      labels:
        severity: critical
        service: frontend
      annotations:
        summary: 'Frontend application is down'
        description: 'The frontend application is not accessible to users.'
        
    # SSL Certificate alerts
    - alert: SSLCertificateExpiringSoon
      expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7  # 7 days
      for: 0m
      labels:
        severity: warning
        service: ssl
      annotations:
        summary: 'SSL certificate expiring soon'
        description: 'SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}'
        
    - alert: SSLCertificateExpired
      expr: probe_ssl_earliest_cert_expiry - time() < 0
      for: 0m
      labels:
        severity: critical
        service: ssl
      annotations:
        summary: 'SSL certificate expired'
        description: 'SSL certificate for {{ $labels.instance }} has expired!'
        
    # Database connection alerts (if applicable)
    - alert: DatabaseConnectionFailed
      expr: increase(database_connection_errors_total[5m]) > 0
      for: 0m
      labels:
        severity: critical
        service: database
      annotations:
        summary: 'Database connection errors'
        description: 'Application is experiencing database connection errors.'
        
    # Resource usage alerts
    - alert: HighCPUUsage
      expr: (100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
      for: 10m
      labels:
        severity: warning
        service: system
      annotations:
        summary: 'High CPU usage'
        description: 'CPU usage is {{ $value }}% on {{ $labels.instance }}'
        
    - alert: HighMemoryUsage
      expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
      for: 5m
      labels:
        severity: warning
        service: system
      annotations:
        summary: 'High memory usage'
        description: 'Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}'
        
    - alert: DiskSpaceLow
      expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) > 0.85
      for: 5m
      labels:
        severity: warning
        service: system
      annotations:
        summary: 'Disk space low'
        description: 'Disk usage is {{ $value | humanizePercentage }} on {{ $labels.instance }} ({{ $labels.device }})'
        
    # Rate limiting alerts
    - alert: RateLimitExceeded
      expr: increase(rate_limit_exceeded_total[5m]) > 10
      for: 2m
      labels:
        severity: warning
        service: rate-limiting
      annotations:
        summary: 'Rate limit frequently exceeded'
        description: 'Rate limit has been exceeded {{ $value }} times in the last 5 minutes.'
        
    # Security alerts
    - alert: UnauthorizedAccess
      expr: increase(http_requests_total{status="401"}[5m]) > 10
      for: 2m
      labels:
        severity: warning
        service: security
      annotations:
        summary: 'Multiple unauthorized access attempts'
        description: 'There have been {{ $value }} unauthorized access attempts in the last 5 minutes.'
        
    - alert: SuspiciousActivity
      expr: increase(http_requests_total{status="403"}[5m]) > 20
      for: 2m
      labels:
        severity: warning
        service: security
      annotations:
        summary: 'Suspicious activity detected'
        description: 'There have been {{ $value }} forbidden requests in the last 5 minutes, which may indicate malicious activity.'