<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustCareConnect Bridge - Monitoring Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Chart.js Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        /* Custom styles for animations */
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-online {
            animation: pulse-green 2s infinite;
        }

        .status-offline {
            animation: pulse-red 1s infinite;
        }

        .sparkline {
            height: 40px;
            width: 100%;
        }

        .metric-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        /* Custom scrollbar for mobile */
        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="activity" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">TrustCareConnect Bridge</h1>
                        <p class="text-sm text-gray-500">Real-time Monitoring Dashboard</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Auto-refresh toggle -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Auto-refresh</span>
                        <button id="autoRefreshToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                        </button>
                    </div>

                    <!-- Last updated time -->
                    <div class="text-sm text-gray-600">
                        Last updated: <span id="lastUpdated" class="font-medium">--:--:--</span>
                    </div>

                    <!-- Connection status indicator -->
                    <div class="flex items-center space-x-2">
                        <div id="connectionStatus" class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span id="connectionText" class="text-sm text-gray-600">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Status Cards Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- WebSocket Status -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">WebSocket Status</p>
                        <p id="wsStatus" class="text-2xl font-bold text-gray-900">Disconnected</p>
                        <p id="wsConnections" class="text-sm text-gray-500">0 active connections</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i data-lucide="wifi" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div id="wsIndicator" class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-gray-400 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Live Query Counter -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Queries Today</p>
                        <p id="queryCount" class="text-2xl font-bold text-gray-900">0</p>
                        <p id="queryRate" class="text-sm text-gray-500">0/min avg</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i data-lucide="message-square" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <canvas id="querySparkline" class="sparkline"></canvas>
                </div>
            </div>

            <!-- Active Users -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Active Users</p>
                        <p id="activeUsers" class="text-2xl font-bold text-gray-900">0</p>
                        <p id="peakUsers" class="text-sm text-gray-500">Peak: 0</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6 text-purple-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex space-x-1">
                        <div class="flex-1 h-2 bg-purple-200 rounded"></div>
                        <div class="flex-1 h-2 bg-purple-300 rounded"></div>
                        <div class="flex-1 h-2 bg-purple-400 rounded"></div>
                        <div class="flex-1 h-2 bg-purple-500 rounded"></div>
                    </div>
                </div>
            </div>

            <!-- Error Rate -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Error Rate</p>
                        <p id="errorRate" class="text-2xl font-bold text-gray-900">0%</p>
                        <p id="errorCount" class="text-sm text-gray-500">0 errors today</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div id="errorIndicator" class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-red-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Safety Score Distribution -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Safety Score Distribution</h3>
                    <i data-lucide="pie-chart" class="w-5 h-5 text-gray-400"></i>
                </div>
                <div class="relative">
                    <canvas id="safetyScoreChart" class="w-full h-64"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="text-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mx-auto mb-1"></div>
                        <p class="text-xs text-gray-600">Safe (70-100)</p>
                        <p id="safeSessions" class="text-sm font-semibold">0</p>
                    </div>
                    <div class="text-center">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full mx-auto mb-1"></div>
                        <p class="text-xs text-gray-600">Moderate (40-69)</p>
                        <p id="moderateSessions" class="text-sm font-semibold">0</p>
                    </div>
                    <div class="text-center">
                        <div class="w-3 h-3 bg-red-500 rounded-full mx-auto mb-1"></div>
                        <p class="text-xs text-gray-600">High Risk (<40)</p>
                        <p id="riskySessions" class="text-sm font-semibold">0</p>
                    </div>
                </div>
            </div>

            <!-- API Response Time -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">API Response Time</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Avg:</span>
                        <span id="avgResponseTime" class="text-sm font-semibold text-blue-600">0ms</span>
                    </div>
                </div>
                <div class="relative">
                    <canvas id="responseTimeChart" class="w-full h-64"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="text-center">
                        <p class="text-xs text-gray-600">P50</p>
                        <p id="p50ResponseTime" class="text-sm font-semibold">0ms</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-600">P95</p>
                        <p id="p95ResponseTime" class="text-sm font-semibold">0ms</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-600">P99</p>
                        <p id="p99ResponseTime" class="text-sm font-semibold">0ms</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Row - Additional Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Doctor Review Queue -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Review Queue</p>
                        <p id="reviewQueue" class="text-2xl font-bold text-gray-900">0</p>
                        <p id="avgReviewTime" class="text-sm text-gray-500">Avg: 0min</p>
                    </div>
                    <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-indigo-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                        <span>Pending</span>
                        <span id="pendingReviews">0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="queueProgress" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Cache Hit Ratio -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Cache Hit Ratio</p>
                        <p id="cacheHitRatio" class="text-2xl font-bold text-gray-900">0%</p>
                        <p id="cacheHits" class="text-sm text-gray-500">0 hits today</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <i data-lucide="database" class="w-6 h-6 text-orange-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                        <span>Hits</span>
                        <span>Misses</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="cacheProgress" class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Novita API Credits -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">API Credits</p>
                        <p id="apiCredits" class="text-2xl font-bold text-gray-900">--</p>
                        <p id="creditsUsed" class="text-sm text-gray-500">Used today: 0</p>
                    </div>
                    <div class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center">
                        <i data-lucide="credit-card" class="w-6 h-6 text-teal-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                        <span>Remaining</span>
                        <span id="creditsPercentage">100%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="creditsProgress" class="bg-teal-500 h-2 rounded-full transition-all duration-300" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- System Health -->
            <div class="metric-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">System Health</p>
                        <p id="systemHealth" class="text-2xl font-bold text-green-600">Healthy</p>
                        <p id="uptime" class="text-sm text-gray-500">Uptime: 0d 0h</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i data-lucide="heart" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="grid grid-cols-3 gap-1">
                        <div id="healthDb" class="h-2 bg-green-500 rounded"></div>
                        <div id="healthRedis" class="h-2 bg-green-500 rounded"></div>
                        <div id="healthApi" class="h-2 bg-green-500 rounded"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600 mt-1">
                        <span>DB</span>
                        <span>Cache</span>
                        <span>API</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile scroll hint -->
        <div class="md:hidden mt-6 text-center">
            <p class="text-xs text-gray-500">
                <i data-lucide="chevron-left" class="w-3 h-3 inline mr-1"></i>
                Scroll horizontally to view all metrics
                <i data-lucide="chevron-right" class="w-3 h-3 inline ml-1"></i>
            </p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-sm text-gray-600">
                    TrustCareConnect Bridge Dashboard © 2024
                </div>
                <div class="flex items-center space-x-4 mt-2 md:mt-0">
                    <a href="/health" class="text-sm text-blue-600 hover:text-blue-800">Health Check</a>
                    <a href="/metrics" class="text-sm text-blue-600 hover:text-blue-800">Raw Metrics</a>
                    <a href="/logs" class="text-sm text-blue-600 hover:text-blue-800">Logs</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Dashboard Controller Class
        class TrustCareDashboard {
            constructor() {
                this.wsConnection = null;
                this.autoRefresh = true;
                this.refreshInterval = null;
                this.charts = {};

                // Data storage
                this.metrics = {
                    queryCount: 0,
                    activeUsers: 0,
                    errorRate: 0,
                    responseTimeHistory: [],
                    safetyScores: { safe: 0, moderate: 0, risky: 0 },
                    reviewQueue: 0,
                    cacheHitRatio: 0,
                    apiCredits: 10000,
                    wsConnections: 0
                };

                this.init();
            }

            init() {
                this.initializeIcons();
                this.setupEventListeners();
                this.initializeCharts();
                this.connectWebSocket();
                this.startAutoRefresh();
                this.updateLastRefreshTime();
            }

            initializeIcons() {
                // Initialize Lucide icons
                lucide.createIcons();
            }

            setupEventListeners() {
                // Auto-refresh toggle
                const autoRefreshToggle = document.getElementById('autoRefreshToggle');
                autoRefreshToggle.addEventListener('click', () => {
                    this.toggleAutoRefresh();
                });

                // Handle page visibility change
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.stopAutoRefresh();
                    } else {
                        this.startAutoRefresh();
                    }
                });

                // Handle window resize for charts
                window.addEventListener('resize', () => {
                    Object.values(this.charts).forEach(chart => {
                        if (chart && chart.resize) {
                            chart.resize();
                        }
                    });
                });
            }

            initializeCharts() {
                this.initQuerySparkline();
                this.initSafetyScoreChart();
                this.initResponseTimeChart();
            }

            initQuerySparkline() {
                const ctx = document.getElementById('querySparkline');
                const data = Array(20).fill(0).map((_, i) => ({
                    x: new Date(Date.now() - (19 - i) * 60000),
                    y: Math.floor(Math.random() * 10)
                }));

                this.charts.querySparkline = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            data: data,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                display: false
                            },
                            y: {
                                display: false,
                                beginAtZero: true
                            }
                        },
                        elements: {
                            point: { radius: 0 }
                        }
                    }
                });
            }

            initSafetyScoreChart() {
                const ctx = document.getElementById('safetyScoreChart');

                this.charts.safetyScore = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Safe (70-100)', 'Moderate (40-69)', 'High Risk (<40)'],
                        datasets: [{
                            data: [75, 20, 5],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 0,
                            cutout: '60%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            initResponseTimeChart() {
                const ctx = document.getElementById('responseTimeChart');
                const data = Array(20).fill(0).map((_, i) => ({
                    x: new Date(Date.now() - (19 - i) * 30000),
                    y: Math.floor(Math.random() * 500) + 200
                }));

                this.charts.responseTime = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Response Time (ms)',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    displayFormats: {
                                        minute: 'HH:mm'
                                    }
                                },
                                ticks: {
                                    maxTicksLimit: 6
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + 'ms';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            connectWebSocket() {
                try {
                    // Try to connect to the bridge WebSocket
                    const wsUrl = `ws://${window.location.hostname}:8080`;
                    this.wsConnection = new WebSocket(wsUrl);

                    this.wsConnection.onopen = () => {
                        this.updateConnectionStatus('connected');
                        this.updateWebSocketStatus('Connected', this.metrics.wsConnections);
                    };

                    this.wsConnection.onclose = () => {
                        this.updateConnectionStatus('disconnected');
                        this.updateWebSocketStatus('Disconnected', 0);

                        // Attempt to reconnect after 5 seconds
                        setTimeout(() => {
                            this.connectWebSocket();
                        }, 5000);
                    };

                    this.wsConnection.onerror = () => {
                        this.updateConnectionStatus('error');
                        this.updateWebSocketStatus('Error', 0);
                    };

                    this.wsConnection.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('Error parsing WebSocket message:', error);
                        }
                    };

                } catch (error) {
                    console.error('WebSocket connection error:', error);
                    this.updateConnectionStatus('error');
                }
            }

            handleWebSocketMessage(data) {
                // Handle real-time updates from the bridge service
                if (data.type === 'metrics') {
                    this.updateMetrics(data.payload);
                } else if (data.type === 'query') {
                    this.incrementQueryCount();
                    this.updateSafetyScore(data.payload.safetyScore);
                } else if (data.type === 'error') {
                    this.incrementErrorCount();
                }
            }

            async fetchMetrics() {
                try {
                    // Fetch metrics from the bridge API
                    const response = await fetch('/api/metrics');
                    if (response.ok) {
                        const data = await response.json();
                        this.updateMetrics(data);
                    }
                } catch (error) {
                    console.error('Error fetching metrics:', error);
                    this.incrementErrorCount();
                }
            }

            updateMetrics(data) {
                // Update all dashboard metrics
                if (data.queryCount !== undefined) {
                    this.updateQueryCount(data.queryCount);
                }

                if (data.activeUsers !== undefined) {
                    this.updateActiveUsers(data.activeUsers);
                }

                if (data.errorRate !== undefined) {
                    this.updateErrorRate(data.errorRate);
                }

                if (data.responseTime !== undefined) {
                    this.updateResponseTime(data.responseTime);
                }

                if (data.reviewQueue !== undefined) {
                    this.updateReviewQueue(data.reviewQueue);
                }

                if (data.cacheHitRatio !== undefined) {
                    this.updateCacheHitRatio(data.cacheHitRatio);
                }

                if (data.apiCredits !== undefined) {
                    this.updateApiCredits(data.apiCredits);
                }

                this.updateLastRefreshTime();
            }

            updateConnectionStatus(status) {
                const indicator = document.getElementById('connectionStatus');
                const text = document.getElementById('connectionText');

                indicator.className = 'w-3 h-3 rounded-full';

                switch (status) {
                    case 'connected':
                        indicator.classList.add('bg-green-500', 'status-online');
                        text.textContent = 'Connected';
                        break;
                    case 'disconnected':
                        indicator.classList.add('bg-red-500', 'status-offline');
                        text.textContent = 'Disconnected';
                        break;
                    case 'error':
                        indicator.classList.add('bg-red-500', 'status-offline');
                        text.textContent = 'Connection Error';
                        break;
                    default:
                        indicator.classList.add('bg-gray-400');
                        text.textContent = 'Connecting...';
                }
            }

            updateWebSocketStatus(status, connections) {
                document.getElementById('wsStatus').textContent = status;
                document.getElementById('wsConnections').textContent = `${connections} active connections`;

                const indicator = document.getElementById('wsIndicator').firstElementChild;
                const percentage = status === 'Connected' ? 100 : 0;
                indicator.style.width = `${percentage}%`;
                indicator.className = `h-full rounded-full transition-all duration-300 ${
                    status === 'Connected' ? 'bg-green-500' : 'bg-red-500'
                }`;
            }

            updateQueryCount(count) {
                this.metrics.queryCount = count;
                document.getElementById('queryCount').textContent = count.toLocaleString();

                // Calculate rate (queries per minute)
                const rate = Math.floor(count / 60); // Simplified calculation
                document.getElementById('queryRate').textContent = `${rate}/min avg`;

                // Update sparkline chart
                if (this.charts.querySparkline) {
                    const now = new Date();
                    const data = this.charts.querySparkline.data.datasets[0].data;
                    data.push({ x: now, y: Math.floor(Math.random() * 10) + 5 });

                    if (data.length > 20) {
                        data.shift();
                    }

                    this.charts.querySparkline.update('none');
                }
            }

            updateActiveUsers(count) {
                this.metrics.activeUsers = count;
                document.getElementById('activeUsers').textContent = count.toLocaleString();

                // Update peak users
                const currentPeak = parseInt(document.getElementById('peakUsers').textContent.split(': ')[1]) || 0;
                if (count > currentPeak) {
                    document.getElementById('peakUsers').textContent = `Peak: ${count}`;
                }
            }

            updateErrorRate(rate) {
                this.metrics.errorRate = rate;
                document.getElementById('errorRate').textContent = `${rate.toFixed(1)}%`;

                const errorCount = Math.floor(this.metrics.queryCount * rate / 100);
                document.getElementById('errorCount').textContent = `${errorCount} errors today`;

                // Update error indicator
                const indicator = document.getElementById('errorIndicator').firstElementChild;
                indicator.style.width = `${Math.min(rate * 10, 100)}%`;
            }

            updateResponseTime(time) {
                // Update response time chart
                if (this.charts.responseTime) {
                    const now = new Date();
                    const data = this.charts.responseTime.data.datasets[0].data;
                    data.push({ x: now, y: time });

                    if (data.length > 100) {
                        data.shift();
                    }

                    this.charts.responseTime.update('none');
                }

                // Update average response time
                document.getElementById('avgResponseTime').textContent = `${time}ms`;

                // Update percentiles (simplified calculation)
                document.getElementById('p50ResponseTime').textContent = `${Math.floor(time * 0.8)}ms`;
                document.getElementById('p95ResponseTime').textContent = `${Math.floor(time * 1.2)}ms`;
                document.getElementById('p99ResponseTime').textContent = `${Math.floor(time * 1.5)}ms`;
            }

            updateSafetyScore(score) {
                // Categorize safety score
                if (score >= 70) {
                    this.metrics.safetyScores.safe++;
                } else if (score >= 40) {
                    this.metrics.safetyScores.moderate++;
                } else {
                    this.metrics.safetyScores.risky++;
                }

                // Update display
                document.getElementById('safeSessions').textContent = this.metrics.safetyScores.safe;
                document.getElementById('moderateSessions').textContent = this.metrics.safetyScores.moderate;
                document.getElementById('riskySessions').textContent = this.metrics.safetyScores.risky;

                // Update chart
                if (this.charts.safetyScore) {
                    const total = this.metrics.safetyScores.safe + this.metrics.safetyScores.moderate + this.metrics.safetyScores.risky;
                    if (total > 0) {
                        this.charts.safetyScore.data.datasets[0].data = [
                            (this.metrics.safetyScores.safe / total * 100).toFixed(1),
                            (this.metrics.safetyScores.moderate / total * 100).toFixed(1),
                            (this.metrics.safetyScores.risky / total * 100).toFixed(1)
                        ];
                        this.charts.safetyScore.update('none');
                    }
                }
            }

            updateReviewQueue(count) {
                this.metrics.reviewQueue = count;
                document.getElementById('reviewQueue').textContent = count;
                document.getElementById('pendingReviews').textContent = count;

                // Update queue progress bar
                const progress = Math.min(count * 10, 100); // Max out at 10 items for visual purposes
                document.getElementById('queueProgress').style.width = `${progress}%`;

                // Update average review time (simulated)
                const avgTime = count > 0 ? Math.floor(Math.random() * 30) + 15 : 0;
                document.getElementById('avgReviewTime').textContent = `Avg: ${avgTime}min`;
            }

            updateCacheHitRatio(ratio) {
                this.metrics.cacheHitRatio = ratio;
                document.getElementById('cacheHitRatio').textContent = `${ratio.toFixed(1)}%`;

                const hits = Math.floor(this.metrics.queryCount * ratio / 100);
                document.getElementById('cacheHits').textContent = `${hits} hits today`;

                // Update progress bar
                document.getElementById('cacheProgress').style.width = `${ratio}%`;
            }

            updateApiCredits(credits) {
                this.metrics.apiCredits = credits;
                document.getElementById('apiCredits').textContent = credits.toLocaleString();

                // Calculate usage (assuming 10000 initial credits)
                const initialCredits = 10000;
                const used = initialCredits - credits;
                document.getElementById('creditsUsed').textContent = `Used today: ${used}`;

                const percentage = (credits / initialCredits) * 100;
                document.getElementById('creditsPercentage').textContent = `${percentage.toFixed(1)}%`;
                document.getElementById('creditsProgress').style.width = `${percentage}%`;

                // Change color based on remaining credits
                const progressBar = document.getElementById('creditsProgress');
                if (percentage < 20) {
                    progressBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-300';
                } else if (percentage < 50) {
                    progressBar.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
                } else {
                    progressBar.className = 'bg-teal-500 h-2 rounded-full transition-all duration-300';
                }
            }

            incrementQueryCount() {
                this.updateQueryCount(this.metrics.queryCount + 1);
            }

            incrementErrorCount() {
                const newErrorRate = ((this.metrics.errorRate * this.metrics.queryCount / 100) + 1) / this.metrics.queryCount * 100;
                this.updateErrorRate(newErrorRate);
            }

            updateLastRefreshTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                document.getElementById('lastUpdated').textContent = timeString;
            }

            toggleAutoRefresh() {
                this.autoRefresh = !this.autoRefresh;
                const toggle = document.getElementById('autoRefreshToggle');
                const slider = toggle.querySelector('span');

                if (this.autoRefresh) {
                    toggle.className = 'relative inline-flex h-6 w-11 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2';
                    slider.className = 'inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6';
                    this.startAutoRefresh();
                } else {
                    toggle.className = 'relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2';
                    slider.className = 'inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1';
                    this.stopAutoRefresh();
                }
            }

            startAutoRefresh() {
                if (this.autoRefresh) {
                    this.stopAutoRefresh(); // Clear any existing interval
                    this.refreshInterval = setInterval(() => {
                        this.fetchMetrics();
                        this.simulateMetrics(); // For demo purposes
                    }, 5000);
                }
            }

            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            }

            // Simulate metrics for demo purposes
            simulateMetrics() {
                // Simulate real-time data
                const simulatedData = {
                    queryCount: this.metrics.queryCount + Math.floor(Math.random() * 3),
                    activeUsers: Math.floor(Math.random() * 50) + 10,
                    errorRate: Math.random() * 2,
                    responseTime: Math.floor(Math.random() * 300) + 200,
                    reviewQueue: Math.floor(Math.random() * 5),
                    cacheHitRatio: 85 + Math.random() * 10,
                    apiCredits: this.metrics.apiCredits - Math.floor(Math.random() * 5)
                };

                this.updateMetrics(simulatedData);

                // Simulate safety score updates
                if (Math.random() > 0.7) {
                    const randomScore = Math.floor(Math.random() * 100);
                    this.updateSafetyScore(randomScore);
                }
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new TrustCareDashboard();
        });
    </script>
</body>
</html>